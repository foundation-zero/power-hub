name: cd

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      deployments: write

    steps:
      - name: Extract alias
        shell: bash
        run: |
          export BRANCH=${GITHUB_REF#refs/heads/}
          echo alias=$(ruby -e "puts '$BRANCH'.tr('/_', '-').chomp('-')[0..27]") >> $GITHUB_OUTPUT
        id: extract-alias

      - uses: chrnorm/deployment-action@v2
        name: Create GitHub deployment
        id: deployment
        with:
          token: "${{ github.token }}"
          initial-status: success
          environment-url: http://${{steps.extract-alias.outputs.alias}}.foundationzero.pages.dev
          environment: ${{steps.deploy.outputs.environment}}

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup node env
        uses: actions/setup-node@v3
        with:
          node-version-file: "./app/.nvmrc"

      - uses: pnpm/action-setup@v2.2.4
        name: Install pnpm
        id: pnpm-install
        with:
          version: 8
          run_install: false

      - name: Install dependencies
        working-directory: ./app
        run: pnpm install

      - name: Lint check
        working-directory: ./app
        run: pnpm lint --max-warnings 0

      - name: Generate website
        working-directory: ./app
        run: pnpm build

      - name: Deploy preview
        id: deploy
        uses: cloudflare/pages-action@1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: power-hub
          directory: "./app/dist"
          wranglerVersion: 3
